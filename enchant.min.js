/*
enchant.js v0.4.0
Copyright (c) Ubiquitous Entertainment Inc.
Dual licensed under the MIT or GPL Version 3 licenses
http://www.opensource.org/licenses/mit-license.php
http://www.gnu.org/licenses/gpl-3.0.html
*/
if(typeof Object.defineProperty!="function")Object.defineProperty=function(f,l,g){if("value"in g)f[l]=g.value;"get"in g&&f.__defineGetter__(l,g.get);"set"in g&&f.__defineSetter__(l,g.set);return f};if(typeof Object.defineProperties!="function")Object.defineProperties=function(f,l){for(var g in l)l.hasOwnProperty(g)&&Object.defineProperty(f,g,l[g]);return f};
if(typeof Object.create!="function")Object.create=function(f,l){function g(){}g.prototype=f;var d=new g;l!=null&&Object.defineProperties(d,l);return d};if(typeof Object.getPrototypeOf!="function")Object.getPrototypeOf=function(f){return f.__proto__};
var enchant=function(f){f!=null&&(f instanceof Array||(f=Array.prototype.slice.call(arguments)),f=f.filter(function(f){return""+f}));(function g(d,n){var a=[],b;for(b in d)d.hasOwnProperty(b)&&(typeof d[b]=="function"?window[b]=d[b]:Object.getPrototypeOf(d[b])==Object.prototype&&(f==null?a.push(b):(e=f.indexOf(n+b),e!=-1&&(a.push(b),f.splice(e,1)))));var e=0;for(b=a.length;e<b;e++)g(d[a[e]],n+a[e]+".")})(enchant,"");if(f!=null&&f.length)throw Error("Cannot load module: "+f.join(", "));};
(function(){var f=function(){var a=navigator.userAgent;return a.indexOf("Opera")!=-1?"O":a.indexOf("MSIE")!=-1?"ms":a.indexOf("WebKit")!=-1?"webkit":navigator.product=="Gecko"?"Moz":""}(),l=function(){var a=document.createElement("div");a.setAttribute("ontouchstart","return");return typeof a.ontouchstart=="function"}(),g=function(){if(navigator.userAgent.indexOf("iPhone")!=-1&&window.devicePixelRatio==2){var a=document.querySelector('meta[name="viewport"]');a==null&&(a=document.createElement("meta"),
document.head.appendChild(a));a.setAttribute("content","width=640px");return!0}else return!1}(),d;enchant.Class=function(a,b){return enchant.Class.create(a,b)};enchant.Class.create=function(a,b){if(arguments.length==0)return enchant.Class.create(Object,b);else if(arguments.length==1&&typeof arguments[0]!="function")return enchant.Class.create(Object,arguments[0]);for(var e in b)if(b.hasOwnProperty(e))if(Object.getPrototypeOf(b[e])==Object.prototype){if(!("enumerable"in b[e]))b[e].enumerable=!0}else b[e]=
{value:b[e],enumerable:!0,writable:!0};var c=function(){if(this instanceof c)c.prototype.initialize.apply(this,arguments);else return new c};c.prototype=Object.create(a.prototype,b);c.prototype.constructor=c;if(c.prototype.initialize==null)c.prototype.initialize=function(){a.apply(this,arguments)};return c};enchant.Event=enchant.Class.create({initialize:function(a){this.type=a;this.target=null;this.localY=this.localX=this.y=this.x=0},_initPosition:function(a,b){this.x=this.localX=(a-d._pageX)/d.scale;
this.y=this.localY=(b-d._pageY)/d.scale}});enchant.Event.LOAD="load";enchant.Event.PROGRESS="progress";enchant.Event.ENTER_FRAME="enterframe";enchant.Event.EXIT_FRAME="exitframe";enchant.Event.ENTER="enter";enchant.Event.EXIT="exit";enchant.Event.ADDED="added";enchant.Event.ADDED_TO_SCENE="addedtoscene";enchant.Event.REMOVED="removed";enchant.Event.REMOVED_FROM_SCENE="removedfromscene";enchant.Event.TOUCH_START="touchstart";enchant.Event.TOUCH_MOVE="touchmove";enchant.Event.TOUCH_END="touchend";enchant.Event.RENDER=
"render";enchant.Event.INPUT_START="inputstart";enchant.Event.INPUT_CHANGE="inputchange";enchant.Event.INPUT_END="inputend";enchant.Event.LEFT_BUTTON_DOWN="leftbuttondown";enchant.Event.LEFT_BUTTON_UP="leftbuttonup";enchant.Event.RIGHT_BUTTON_DOWN="rightbuttondown";enchant.Event.RIGHT_BUTTON_UP="rightbuttonup";enchant.Event.UP_BUTTON_DOWN="upbuttondown";enchant.Event.UP_BUTTON_UP="upbuttonup";enchant.Event.DOWN_BUTTON_DOWN="downbuttondown";enchant.Event.DOWN_BUTTON_UP="downbuttonup";enchant.Event.A_BUTTON_DOWN=
"abuttondown";enchant.Event.A_BUTTON_UP="abuttonup";enchant.Event.B_BUTTON_DOWN="bbuttondown";enchant.Event.B_BUTTON_UP="bbuttonup";enchant.EventTarget=enchant.Class.create({initialize:function(){this._listeners={}},addEventListener:function(a,b){var e=this._listeners[a];e==null?this._listeners[a]=[b]:e.indexOf(b)==-1&&e.unshift(b)},removeEventListener:function(a,b){var e=this._listeners[a];if(e!=null){var c=e.indexOf(b);c!=-1&&e.splice(c,1)}},dispatchEvent:function(a){a.target=this;a.localX=a.x-
this._offsetX;a.localY=a.y-this._offsetY;if(this["on"+a.type]!=null)this["on"+a.type]();var b=this._listeners[a.type];if(b!=null)for(var b=b.slice(),e=0,c=b.length;e<c;e++)b[e].call(this,a)}});enchant.Game=enchant.Class.create(enchant.EventTarget,{initialize:function(a,b){enchant.EventTarget.call(this);var e=!0;d&&(e=!1,d.stop());d=enchant.Game.instance=this;this.width=a||320;this.height=b||320;this.scale=1;var c=document.getElementById("enchant-stage");if(c){var m=window.getComputedStyle(c),a=parseInt(m.width),
b=parseInt(m.height);a&&b?this.scale=Math.min(a/this.width,b/this.height):(c.style.width=this.width+"px",c.style.height=this.height+"px");for(;c.firstChild;)c.removeChild(c.firstChild);c.style.position="relative";m=c.getBoundingClientRect();this._pageX=Math.round(window.scrollX+m.left);this._pageY=Math.round(window.scrollY+m.top)}else c=document.createElement("div"),c.id="enchant-stage",c.style.width=window.innerWidth+"px",c.style.height=window.innerHeight+"px",c.style.position="absolute",document.body.firstChild?
document.body.insertBefore(c,document.body.firstChild):document.body.appendChild(c),this.scale=Math.min(window.innerWidth/this.width,window.innerHeight/this.height),this._pageY=this._pageX=0;if(!this.scale)this.scale=1;c.style.fontSize="12px";c.style.webkitTextSizeAdjust="none";this._element=c;this.fps=30;this.frame=0;this.ready=null;this.running=!1;this.assets={};var h=this._assets=[];(function q(a){a.assets instanceof Array&&[].push.apply(h,a.assets);for(var b in a)a.hasOwnProperty(b)&&Object.getPrototypeOf(a[b])==
Object.prototype&&q(a[b])})(enchant);this._scenes=[];this.currentScene=null;this.rootScene=new enchant.Scene;this.pushScene(this.rootScene);this.loadingScene=new enchant.Scene;this.loadingScene.backgroundColor="#000";var j=this.width*0.9|0,o=this.width*0.3|0,k=j*0.05|0,c=new enchant.Sprite(j,o);c.x=(this.width-j)/2;c.y=(this.height-o)/2;var i=new enchant.Surface(j,o);i.context.fillStyle="#fff";i.context.fillRect(0,0,j,o);i.context.fillStyle="#000";i.context.fillRect(k,k,j-k*2,o-k*2);c.image=i;var f=
0,g=0;this.addEventListener("progress",function(a){f=a.loaded/a.total});c.addEventListener("enterframe",function(){g*=0.9;g+=f*0.1;i.context.fillStyle="#fff";i.context.fillRect(k,0,(j-k*2)*g,o)});this.loadingScene.addChild(c);this._soundID=this._surfaceID=this._mousedownID=0;this._intervalID=null;this.input={};this._keybind={};this.keybind(37,"left");this.keybind(38,"up");this.keybind(39,"right");this.keybind(40,"down");var n=0;["left","right","up","down","a","b"].forEach(function(a){this.addEventListener(a+
"buttondown",function(b){this.input[a]||(this.input[a]=!0,this.dispatchEvent(new enchant.Event(n++?"inputchange":"inputstart")));this.currentScene.dispatchEvent(b)});this.addEventListener(a+"buttonup",function(b){this.input[a]&&(this.input[a]=!1,this.dispatchEvent(new enchant.Event(--n?"inputchange":"inputend")));this.currentScene.dispatchEvent(b)})},this);e&&(document.addEventListener("keydown",function(a){d.dispatchEvent(new enchant.Event("keydown"));if(37<=a.keyCode&&a.keyCode<=40||a.keyCode==
32)a.preventDefault(),a.stopPropagation();if(d.running&&(a=d._keybind[a.keyCode]))a=new enchant.Event(a+"buttondown"),d.dispatchEvent(a)},!0),document.addEventListener("keyup",function(a){if(d.running&&(a=d._keybind[a.keyCode]))a=new enchant.Event(a+"buttonup"),d.dispatchEvent(a)},!0),l?(document.addEventListener("touchstart",function(a){a.preventDefault();d.running||a.stopPropagation()},!0),document.addEventListener("touchmove",function(a){a.preventDefault();d.running||a.stopPropagation()},!0),document.addEventListener("touchend",
function(a){a.preventDefault();d.running||a.stopPropagation()},!0)):(document.addEventListener("mousedown",function(a){a.preventDefault();d._mousedownID++;d.running||a.stopPropagation()},!0),document.addEventListener("mousemove",function(a){a.preventDefault();d.running||a.stopPropagation()},!0),document.addEventListener("mouseup",function(a){a.preventDefault();d.running||a.stopPropagation()},!0)))},preload:function(a){a instanceof Array||(a=Array.prototype.slice.call(arguments));[].push.apply(this._assets,
a)},load:function(a,b){b==null&&(b=function(){});var e=a.match(/\.\w+$/)[0];e&&(e=e.slice(1).toLowerCase());switch(e){case "jpg":case "gif":case "png":d.assets[a]=enchant.Surface.load(a);d.assets[a].addEventListener("load",b);break;case "mp3":case "aac":case "m4a":case "wav":case "ogg":d.assets[a]=enchant.Sound.load(a,"audio/"+e);d.assets[a].addEventListener("load",b);break;default:var c=new XMLHttpRequest;c.open("GET",a,!0);c.onreadystatechange=function(){if(c.readyState==4){if(c.status!=200)throw Error("Cannot load an asset: "+
a);var e=c.getResponseHeader("Content-Type")||"";e.match(/^image/)?(d.assets[a]=enchant.Surface.load(a),d.assets[a].addEventListener("load",b)):e.match(/^audio/)?(d.assets[a]=enchant.Sound.load(a,e),d.assets[a].addEventListener("load",b)):(d.assets[asset]=c.responseText,b())}};c.send(null)}},start:function(){if(this._intervalID)window.clearInterval(this._intervalID);else if(this._assets.length){var a={},b=this._assets.filter(function(b){return b in a?!1:a[b]=!0}),e=0,c=0,m=b.length;for(;c<m;c++)this.load(b[c],
function(){var a=new enchant.Event("progress");a.loaded=++e;a.total=m;d.dispatchEvent(a);e==m&&(d.removeScene(d.loadingScene),d.dispatchEvent(new enchant.Event("load")))});this.pushScene(this.loadingScene)}else this.dispatchEvent(new enchant.Event("load"));this.currentTime=Date.now();this._intervalID=window.setInterval(function(){d._tick()},1E3/this.fps);this.running=!0},_tick:function(){var a=Date.now(),b=new enchant.Event("enterframe");b.elapsed=a-this.currentTime;this.currentTime=a;for(var a=this.currentScene.childNodes.slice(),
e=Array.prototype.push;a.length;){var c=a.pop();c.dispatchEvent(b);c.childNodes&&e.apply(a,c.childNodes)}this.currentScene.dispatchEvent(b);this.dispatchEvent(b);this.dispatchEvent(new enchant.Event("exitframe"));this.frame++},stop:function(){if(this._intervalID)window.clearInterval(this._intervalID),this._intervalID=null;this.running=!1},pause:function(){if(this._intervalID)window.clearInterval(this._intervalID),this._intervalID=null},pushScene:function(a){this._element.appendChild(a._element);this.currentScene&&
this.currentScene.dispatchEvent(new enchant.Event("exit"));this.currentScene=a;this.currentScene.dispatchEvent(new enchant.Event("enter"));return this._scenes.push(a)},popScene:function(){if(this.currentScene!=this.rootScene)return this._element.removeChild(this.currentScene._element),this.currentScene.dispatchEvent(new enchant.Event("exit")),this.currentScene=this._scenes[this._scenes.length-2],this.currentScene.dispatchEvent(new enchant.Event("enter")),this._scenes.pop()},replaceScene:function(a){this.popScene();
return this.pushScene(a)},removeScene:function(a){if(this.currentScene==a)return this.popScene();else{var b=this._scenes.indexOf(a);if(b!=-1)return this._scenes.splice(b,1),this._element.removeChild(a._element),a}},keybind:function(a,b){this._keybind[a]=b}});enchant.Game.instance=null;enchant.Node=enchant.Class.create(enchant.EventTarget,{initialize:function(){enchant.EventTarget.call(this);this._offsetY=this._offsetX=this._y=this._x=0;this.scene=this.parentNode=null;this.addEventListener("touchstart",
function(a){this.parentNode&&this.parentNode!=this.scene&&this.parentNode.dispatchEvent(a)});this.addEventListener("touchmove",function(a){this.parentNode&&this.parentNode!=this.scene&&this.parentNode.dispatchEvent(a)});this.addEventListener("touchend",function(a){this.parentNode&&this.parentNode!=this.scene&&this.parentNode.dispatchEvent(a)})},moveTo:function(a,b){this._x=a;this._y=b;this._updateCoordinate()},moveBy:function(a,b){this._x+=a;this._y+=b;this._updateCoordinate()},x:{get:function(){return this._x},
set:function(a){this._x=a;this._updateCoordinate()}},y:{get:function(){return this._y},set:function(a){this._y=a;this._updateCoordinate()}},_updateCoordinate:function(){this.parentNode?(this._offsetX=this.parentNode._offsetX+this._x,this._offsetY=this.parentNode._offsetY+this._y):(this._offsetX=this._x,this._offsetY=this._y)}});enchant.Entity=enchant.Class.create(enchant.Node,{initialize:function(){enchant.Node.call(this);this._element=document.createElement("div");this._style=this._element.style;
this._style.position="absolute";this._height=this._width=0;this._backgroundColor=null;this._opacity=1;this._visible=!0;this.buttonMode=this._buttonMode=null;this.buttonPressed=!1;this.addEventListener("touchstart",function(){if(this.buttonMode){this.buttonPressed=!0;var a=new Event(button+"buttondown");this.dispatchEvent(a);d.dispatchEvent(a)}});this.addEventListener("touchend",function(){if(this.buttonMode){this.buttonPressed=!1;var a=new Event(button+"buttonup");this.dispatchEvent(a);d.dispatchEvent(a)}});
var a=this,b=function(){a.dispatchEvent(new enchant.Event("render"))};this.addEventListener("addedtoscene",function(){b();d.addEventListener("exitframe",b)});this.addEventListener("removedfromscene",function(){d.removeEventListener("exitframe",b)});this.addEventListener("render",function(){if(this._offsetX!=this._previousOffsetX)this._style.left=this._offsetX+"px";if(this._offsetY!=this._previousOffsetY)this._style.top=this._offsetY+"px";this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY});
a=this;l?(this._element.addEventListener("touchstart",function(b){for(var c=b.touches,d=0,h=c.length;d<h;d++)b=new enchant.Event("touchstart"),b.identifier=c[d].identifier,b._initPosition(c[d].pageX,c[d].pageY),a.dispatchEvent(b)},!1),this._element.addEventListener("touchmove",function(b){for(var c=b.touches,d=0,h=c.length;d<h;d++)b=new enchant.Event("touchmove"),b.identifier=c[d].identifier,b._initPosition(c[d].pageX,c[d].pageY),a.dispatchEvent(b)},!1),this._element.addEventListener("touchend",function(b){for(var c=
b.changedTouches,d=0,h=c.length;d<h;d++)b=new enchant.Event("touchend"),b.identifier=c[d].identifier,b._initPosition(c[d].pageX,c[d].pageY),a.dispatchEvent(b)},!1)):(this._element.addEventListener("mousedown",function(b){var c=b.pageX,m=b.pageY,b=new enchant.Event("touchstart");b.identifier=d._mousedownID;b._initPosition(c,m);a.dispatchEvent(b);a._mousedown=!0},!1),d._element.addEventListener("mousemove",function(b){if(a._mousedown){var c=b.pageX,m=b.pageY,b=new enchant.Event("touchmove");b.identifier=
d._mousedownID;b._initPosition(c,m);a.dispatchEvent(b)}},!1),d._element.addEventListener("mouseup",function(b){if(a._mousedown){var c=b.pageX,m=b.pageY,b=new enchant.Event("touchend");b.identifier=d._mousedownID;b._initPosition(c,m);a.dispatchEvent(b);a._mousedown=!1}},!1))},width:{get:function(){return this._width},set:function(a){this._style.width=(this._width=a)+"px"}},height:{get:function(){return this._height},set:function(a){this._style.height=(this._height=a)+"px"}},backgroundColor:{get:function(){return this._backgroundColor},
set:function(a){this._element.style.backgroundColor=this._backgroundColor=a}},opacity:{get:function(){return this._opacity},set:function(a){this._style.opacity=this._opacity=a}},visible:{get:function(){return this._visible},set:function(a){this._style.display=(this._visible=a)?"block":"none"}},touchEnabled:{get:function(){return this._touchEnabled},set:function(a){this._style.pointerEvents=(this._touchEnabled=a)?"all":"none"}},intersect:function(a){return this.x<a.x+a.width&&a.x<this.x+this.width&&
this.y<a.y+a.height&&a.y<this.y+this.height},within:function(a,b){b==null&&(b=(this.width+this.height+a.width+a.height)/4);var e;return(e=this.x-a.x+(this.width-a.width)/2)*e+(e=this.y-a.y+(this.height-a.height)/2)*e<b*b}});enchant.Sprite=enchant.Class.create(enchant.Entity,{initialize:function(a,b){enchant.Entity.call(this);this.width=a;this.height=b;this._scaleY=this._scaleX=1;this._rotation=0;this._dirty=!1;this._image=null;this._frame=0;this._style.overflow="hidden";this.addEventListener("render",
function(){if(this._dirty)this._style[f+"Transform"]=["rotate(",this._rotation,"deg)scale(",this._scaleX,",",this._scaleY,")"].join(""),this._dirty=!1})},image:{get:function(){return this._image},set:function(a){if(a!=this._image){if(this._image!=null)if(this._image.css)this._style.backgroundImage="";else if(this._element.firstChild)this._element.removeChild(this._element.firstChild),this._dirtyListener?(this.removeEventListener("render",this._dirtyListener),this._dirtyListener=null):this._image._parent=
null;if(a!=null)if(a._css)this._style.backgroundImage=a._css;else if(a._parent){var b=document.createElement("canvas"),e=b.getContext("2d");b.width=a.width;b.height=a.height;e.drawImage(a._element,0,0);this._dirtyListener=function(){if(a._dirty)e.drawImage(a._element),a._dirty=!1};this.addEventListener("render",this._dirtyListener);this._element.appendChild(b)}else a._parent=this,this._element.appendChild(a._element);this._image=a}}},frame:{get:function(){return this._frame},set:function(a){this._frame=
a;var b=this._image.width/this._width|0;if(this._image._css)this._style.backgroundPosition=[-(a%b)*this._width,"px ",-(a/b|0)*this._height,"px"].join("");else if(this._element.firstChild){var e=this._element.firstChild.style;e.left=-(a%b)*this._width+"px";e.top=-(a/b|0)*this._height+"px"}}},scale:function(a,b){b==null&&(b=a);this._scaleX*=a;this._scaleY*=b;this._dirty=!0},rotate:function(a){this._rotation+=a;this._dirty=!0},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=
a;this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;this._dirty=!0}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;this._dirty=!0}}});enchant.Label=enchant.Class.create(enchant.Entity,{initialize:function(a){enchant.Entity.call(this);this.width=300;this.text=a},text:{get:function(){return this._element.innerHTML},set:function(a){this._element.innerHTML=a}},font:{get:function(){return this._style.font},set:function(a){this._style.font=
a}},color:{get:function(){return this._style.color},set:function(a){this._style.color=a}}});enchant.Map=enchant.Class.create(enchant.Entity,{initialize:function(a,b){enchant.Entity.call(this);var e=document.createElement("canvas");g&&d.scale==2?(e.width=d.width*2,e.height=d.height*2,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(e.width=d.width,e.height=d.height);this._element.appendChild(e);this._context=e.getContext("2d");this._tileWidth=a||0;this._tileHeight=
b||0;this._image=null;this._data=[[[]]];this.touchEnabled=this._tight=this._dirty=!1;this.collisionData=null;this._listeners.render=null;this.addEventListener("render",function(){if(this._dirty||this._previousOffsetX==null)this._dirty=!1,this.redraw(0,0,d.width,d.height);else if(this._offsetX!=this._previousOffsetX||this._offsetY!=this._previousOffsetY)if(this._tight){var a=-this._offsetX,b=-this._offsetY,e=-this._previousOffsetX,j=-this._previousOffsetY,f=a-e+d.width,k=e-a+d.width,i=b-j+d.height,
g=j-b+d.height;if(f>this._tileWidth&&k>this._tileWidth&&i>this._tileHeight&&g>this._tileHeight){var l;f<k?(l=0,a=e-a,k=f):(l=a-e,a=0);i<g?(f=0,b=j-b):(f=b-j,b=0,i=g);if(d._buffer==null)d._buffer=document.createElement("canvas"),d._buffer.width=this._context.canvas.width,d._buffer.height=this._context.canvas.height;g=d._buffer.getContext("2d");this._doubledImage?(g.clearRect(0,0,k*2,i*2),g.drawImage(this._context.canvas,l*2,f*2,k*2,i*2,0,0,k*2,i*2),g=this._context,g.clearRect(a*2,b*2,k*2,i*2),g.drawImage(d._buffer,
0,0,k*2,i*2,a*2,b*2,k*2,i*2)):(g.clearRect(0,0,k,i),g.drawImage(this._context.canvas,l,f,k,i,0,0,k,i),g=this._context,g.clearRect(a,b,k,i),g.drawImage(d._buffer,0,0,k,i,a,b,k,i));a==0?this.redraw(k,0,d.width-k,d.height):this.redraw(0,0,d.width-k,d.height);b==0?this.redraw(0,i,d.width,d.height-i):this.redraw(0,0,d.width,d.height-i)}else this.redraw(0,0,d.width,d.height)}else this.redraw(0,0,d.width,d.height);this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY})},loadData:function(a){this._data=
Array.prototype.slice.apply(arguments);this._dirty=!0;this._tight=!1;for(var b=0,e=this._data.length;b<e;b++){for(var c=0,a=this._data[b],d=0,h=a.length;d<h;d++)for(var j=0,f=a[d].length;j<f;j++)a[d][j]>=0&&c++;if(c/(a.length*a[0].length)>0.2){this._tight=!0;break}}},hitTest:function(a,b){if(a<0||this.width<=a||b<0||this.height<=b)return!1;var e=this._image.width,c=this._image.height,d=this._tileWidth||e,h=this._tileHeight||c,a=a/d|0,b=b/h|0;if(this.collisionData!=null)return this.collisionData[b]&&
!!this.collisionData[b][a];else{for(var j=0,f=this._data.length;j<f;j++){var g=this._data[j],i;if(g[b]!=null&&(i=g[b][a])!=null&&0<=i&&i<(e/d|0)*(c/h|0))return!0}return!1}},image:{get:function(){return this._image},set:function(a){this._image=a;if(g&&d.scale==2){for(var b=new Surface(a.width*2,a.height*2),e=this._tileWidth||a.width,c=this._tileHeight||a.height,m=a.width/e|0,h=a.height/c|0,j=0;j<h;j++)for(var f=0;f<m;f++)b.draw(a,f*e,j*c,e,c,f*e*2,j*c*2,e*2,c*2);this._doubledImage=b}this._dirty=!0}},
tileWidth:{get:function(){return this._tileWidth},set:function(a){this._tileWidth=a;this._dirty=!0}},tileHeight:{get:function(){return this._tileHeight},set:function(a){this._tileHeight=a;this._dirty=!0}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(a,b,e,c){if(this._image!=null){var d,h,f,g,k;this._doubledImage?(d=this._doubledImage,h=this._tileWidth*2,f=this._tileHeight*2,g=-this._offsetX*
2,k=-this._offsetY*2,a*=2,b*=2,e*=2,c*=2):(d=this._image,h=this._tileWidth,f=this._tileHeight,g=-this._offsetX,k=-this._offsetY);var i=d.width/h|0,l=d.height/f|0,n=Math.max((a+g)/h|0,0),t=Math.max((b+k)/f|0,0),u=Math.ceil((a+g+e)/h),q=Math.ceil((b+k+c)/f);d=d._element;var s=this._context;s.clearRect(a,b,e,c);e=0;for(c=this._data.length;e<c;e++)for(var r=this._data[e],v=Math.min(u,r[0].length),w=Math.min(q,r.length),b=t;b<w;b++)for(a=n;a<v;a++){var p=r[b][a];0<=p&&p<i*l&&s.drawImage(d,p%i*h,(p/i|0)*
f,h,f,a*h-g,b*f-k,h,f)}}}});enchant.Group=enchant.Class.create(enchant.Node,{initialize:function(){enchant.Node.call(this);this.childNodes=[];this._y=this._x=0},addChild:function(a){this.childNodes.push(a);a.parentNode=this;a.dispatchEvent(new enchant.Event("added"));if(this.scene){var b=new enchant.Event("addedtoscene");a.scene=this.scene;a.dispatchEvent(b);a._updateCoordinate();var e=document.createDocumentFragment(),c,d=Array.prototype.push;if(a._element)e.appendChild(a._element);else if(a.childNodes)for(c=
a.childNodes.slice().reverse();c.length;)a=c.pop(),a.scene=this.scene,a.dispatchEvent(b),a._element?e.appendChild(a._element):a.childNodes&&d.apply(c,a.childNodes.reverse());if(e.childNodes.length){for(var f,b=this;b.parentNode;){c=b.parentNode.childNodes;for(c=c.slice(c.indexOf(b)+1).reverse();c.length;)if(a=c.pop(),a._element){f=a._element;break}else a.childNodes&&d.apply(c,a.childNodes.slice().reverse());b=b.parentNode}f?this.scene._element.insertBefore(e,f):this.scene._element.appendChild(e)}}},
insertBefore:function(a,b){var e=this.childNodes.indexOf(b);if(e!=-1){if(this.childNodes.splice(e,0,a),a.parentNode=this,a.dispatchEvent(new enchant.Event("added")),this.scene){var c=new enchant.Event("addedtoscene");a.scene=this.scene;a.dispatchEvent(c);a._updateCoordinate();var d=document.createDocumentFragment(),f,g=Array.prototype.push;if(a._element)d.appendChild(a._element);else if(a.childNodes)for(f=a.childNodes.slice().reverse();f.length;)a=f.pop(),a.scene=this.scene,a.dispatchEvent(c),a._element?
d.appendChild(a._element):a.childNodes&&g.apply(f,a.childNodes.reverse());if(d.childNodes.length){for(var l,c=b;c.parentNode;){e!=null?(f=this.childNodes.slice(e+1).reverse(),e=null):(f=c.parentNode.childNodes,f=f.slice(f.indexOf(c)+1).reverse());for(;f.length;)if(a=f.pop(),a._element){l=a._element;break}else a.childNodes&&g.apply(f,a.childNodes.slice().reverse());c=c.parentNode}l?this.scene._element.insertBefore(d,l):this.scene._element.appendChild(d)}}}else this.addChild(a)},removeChild:function(a){var b=
this.childNodes.indexOf(a);if(b!=-1&&(this.childNodes.splice(b,1),a.parentNode=null,a.dispatchEvent(new enchant.Event("removed")),this.scene))if(b=new enchant.Event("removedfromscene"),a.scene=null,a.dispatchEvent(b),a._element)this.scene._element.removeChild(a._element);else if(a.childNodes)for(var e=a.childNodes.slice(),c=Array.prototype.push;e.length;)a=e.pop(),a.scene=null,a.dispatchEvent(b),a._element?this.scene._element.removeChild(a._element):a.childNodes&&c.apply(e,a.childNodes)},firstChild:{get:function(){return this.childNodes[0]}},
lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},_updateCoordinate:function(){this.parentNode?(this._offsetX=this.parentNode._offsetX+this._x,this._offsetY=this.parentNode._offsetY+this._y):(this._offsetX=this._x,this._offsetY=this._y);for(var a=0,b=this.childNodes.length;a<b;a++)this.childNodes[a]._updateCoordinate()}});enchant.Scene=enchant.Class.create(enchant.Group,{initialize:function(){enchant.Group.call(this);this._element=document.createElement("div");this._element.style.position=
"absolute";this._element.style.overflow="hidden";this._element.style.width=(this.width=d.width)+"px";this._element.style.height=(this.height=d.height)+"px";this._element.style[f+"TransformOrigin"]="0 0";this._element.style[f+"Transform"]="scale("+d.scale+")";this.scene=this;var a=this;l?(this._element.addEventListener("touchstart",function(b){for(var e=b.touches,c=0,d=e.length;c<d;c++)b=new enchant.Event("touchstart"),b.identifier=e[c].identifier,b._initPosition(e[c].pageX,e[c].pageY),a.dispatchEvent(b)},
!1),this._element.addEventListener("touchmove",function(b){for(var e=b.touches,c=0,d=e.length;c<d;c++)b=new enchant.Event("touchmove"),b.identifier=e[c].identifier,b._initPosition(e[c].pageX,e[c].pageY),a.dispatchEvent(b)},!1),this._element.addEventListener("touchend",function(b){for(var e=b.changedTouches,c=0,d=e.length;c<d;c++)b=new enchant.Event("touchend"),b.identifier=e[c].identifier,b._initPosition(e[c].pageX,e[c].pageY),a.dispatchEvent(b)},!1)):(this._element.addEventListener("mousedown",function(b){var e=
b.pageX,c=b.pageY,b=new enchant.Event("touchstart");b.identifier=d._mousedownID;b._initPosition(e,c);a.dispatchEvent(b);a._mousedown=!0},!1),d._element.addEventListener("mousemove",function(b){if(a._mousedown){var e=b.pageX,c=b.pageY,b=new enchant.Event("touchmove");b.identifier=d._mousedownID;b._initPosition(e,c);a.dispatchEvent(b)}},!1),d._element.addEventListener("mouseup",function(b){if(a._mousedown){var e=b.pageX,c=b.pageY,b=new enchant.Event("touchend");b.identifier=d._mousedownID;b._initPosition(e,
c);a.dispatchEvent(b);a._mousedown=!1}},!1))},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._element.style.backgroundColor=this._backgroundColor=a}},_updateCoordinate:function(){this._offsetX=this._x;this._offsetY=this._y;for(var a=0,b=this.childNodes.length;a<b;a++)this.childNodes[a]._updateCoordinate()}});var n=["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"];enchant.Surface=enchant.Class.create(enchant.EventTarget,
{initialize:function(a,b){enchant.EventTarget.call(this);this.width=a;this.height=b;this.context=null;var e="enchant-surface"+d._surfaceID++;document.getCSSCanvasContext?(this.context=document.getCSSCanvasContext("2d",e,a,b),this._element=this.context.canvas,this._css="-webkit-canvas("+e+")"):document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._css="-moz-element(#"+e+")",this.context=this._element.getContext("2d"),document.mozSetImageElement(e,
this._element)):(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._element.style.position="absolute",this.context=this._element.getContext("2d"),n.forEach(function(a){var b=this.context[a];this.context[a]=function(){b.apply(this,arguments);this._dirty=!0}},this))},getPixel:function(a,b){return this.context.getImageData(a,b,1,1).data},setPixel:function(a,b,d,c,f,g){var j=this.context.createImageData(1,1);j.data[0]=d;j.data[1]=c;j.data[2]=f;j.data[3]=
g;this.context.putImageData(j,a,b,1,1)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(a){arguments[0]=a=a._element;arguments.length==1?this.context.drawImage(a,0,0):this.context.drawImage.apply(this.context,arguments)},clone:function(){var a=new enchant.Surface(this.width,this.height);a.draw(this);return a}});enchant.Surface.load=function(a){var b=new Image,d=Object.create(Surface.prototype,{context:{value:null},_css:{value:"url("+a+")"},_element:{value:b}});enchant.EventTarget.call(d);
b.src=a;b.onerror=function(){throw Error("Cannot load an asset: "+b.src);};b.onload=function(){d.width=b.width;d.height=b.height;d.dispatchEvent(new enchant.Event("load"))};return d};enchant.Sound=enchant.Class.create(enchant.EventTarget,{initialize:function(){enchant.EventTarget.call(this);throw Error("Illegal Constructor");},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},stop:function(){this.pause();this.currentTime=0},currentTime:{get:function(){return this._element?
this._element.currentTime:0},set:function(a){if(this._element)this._element.currentTime=a}},volume:{get:function(){return this._element?this._element.volume:1},set:function(a){if(this._element)this._element.volume=a}}});enchant.Sound.load=function(a,b){if(b==null)var e=a.match(/\.\w+$/)[0],b=e?"audio/"+e.slice(1).toLowerCase():"";var e=f=="webkit"&&l,c=Object.create(enchant.Sound.prototype);enchant.EventTarget.call(c);var g=new Audio;if(g.canPlayType(b)&&!e)g.src=a,g.autoplay=!1,g.onerror=function(){throw Error("Cannot load an asset: "+
g.src);},g.addEventListener("canplaythrough",function(){c.duration=g.duration;c.dispatchEvent(new enchant.Event("load"))},!1),c._element=g;else if(b.match(/^audio\/(mpeg|mp3)/)&&!e){var h=document.createElement("embed"),e="enchant-audio"+d._soundID++;h.width=h.height=1;h.name=e;h.src="sound.swf?id=&src="+a;h.allowscriptaccess="always";h.style.position="absolute";h.style.left="-1px";c.addEventListener("load",function(){Object.defineProperties(h,{currentTime:{get:function(){return h.getCurrentTime()},
set:function(a){h.setCurrentTime(a)}},volume:{get:function(){return h.getVolume()},set:function(a){h.setVolume(a)}}});c._element=h;c.duration=h.getDuration()});d._element.appendChild(h);enchant.Sound[e]=c}else window.setTimeout(function(){c.dispatchEvent(new enchant.Event("load"))},0);return c}})();
